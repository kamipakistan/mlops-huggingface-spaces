name: Sync to Hugging Face hub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python (optional)
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Configure Git user
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Prepare HF space clone (create or update)
        env:
          HF_USERNAME: kamipakistan
          HF_SPACE: text_summarization_app
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          HF_REMOTE="https://huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE}.git"
          echo "HF remote: ${HF_USERNAME}/${HF_SPACE}"

          # Clean old clone
          rm -rf hf-space

          # Try to clone remote; if empty or missing, init a new repo
          git clone --depth=1 "${HF_REMOTE}" hf-space || {
            echo "Remote Space not found or empty â€” initializing new repo directory"
            mkdir -p hf-space
            cd hf-space
            git init
            git remote add origin "${HF_REMOTE}"
            cd ..
          }

          # Copy current repo contents into hf-space, excluding .git and the hf-space dir itself
          rsync -av --delete --exclude='.git' --exclude='hf-space' ./ hf-space/

          cd hf-space
          git status --porcelain || true

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Sync from GitHub Actions: ${GITHUB_SHA}"
          else
            echo "No changes to commit."
          fi

          # Push using token-authenticated HTTPS URL
          PUSH_URL="https://${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE}.git"
          git push "${PUSH_URL}" HEAD:main --force
